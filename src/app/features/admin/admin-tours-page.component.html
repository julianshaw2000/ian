<div class="vh-admin-shell">
  <mat-toolbar color="primary" class="vh-admin-toolbar">
    <span class="vh-admin-title">
      <mat-icon>map</mat-icon>
      <span>Tours manager</span>
    </span>

    <span class="vh-admin-toolbar-spacer"></span>

    <span *ngIf="auth.userEmail() as email" class="vh-admin-user">
      {{ email }}
    </span>

    <a
      mat-button
      routerLink="/admin/dashboard"
      [ngClass]="{ 'vh-admin-button--mobile': isMobile() }"
      matTooltip="Dashboard"
    >
      <mat-icon>dashboard</mat-icon>
      <span>Dashboard</span>
    </a>

    <button
      mat-button
      type="button"
      (click)="logout()"
      [ngClass]="{ 'vh-admin-button--mobile': isMobile() }"
      matTooltip="Logout"
    >
      <mat-icon>logout</mat-icon>
      <span>Logout</span>
    </button>

    <a
      mat-button
      routerLink="/"
      [ngClass]="{ 'vh-admin-button--mobile': isMobile() }"
      matTooltip="Back to app"
    >
      <mat-icon>home</mat-icon>
      <span>Back to app</span>
    </a>
  </mat-toolbar>

  <main class="vh-admin-main">
    <section class="vh-admin-layout">
      <mat-card class="vh-admin-list">
        <mat-card-header>
          <mat-card-title>Existing tours</mat-card-title>
          <mat-card-subtitle>Select a tour to edit or create a new one</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <button
            mat-stroked-button
            color="primary"
            (click)="newTour()"
            [ngClass]="{ 'vh-admin-button--mobile': isMobile() }"
            matTooltip="Create new tour"
          >
            <mat-icon>add</mat-icon>
            <span>New tour</span>
          </button>

          <ul class="vh-admin-tours">
            <li *ngFor="let tour of tours()">
              <button
                mat-button
                type="button"
                (click)="editTour(tour)"
                [class.vh-admin-tours-selected]="tour.id === selectedId()"
                matTooltip="Edit tour"
              >
                <span class="vh-admin-tour-title">{{ tour.title }}</span>
                <span class="vh-admin-tour-meta">
                  {{ tour.location || 'Unknown location' }} 路 {{ tour.distance_km ?? 0 }} km 路
                  {{ tour.duration_minutes ?? 0 }} min
                  <span *ngIf="tour.is_published">路 Published</span>
                  <span *ngIf="!tour.is_published">路 Draft</span>
                </span>
              </button>

              <a
                mat-icon-button
                color="primary"
                [routerLink]="['/admin/tours', tour.id, 'pois']"
                aria-label="Manage stops"
                matTooltip="Manage stops"
              >
                <mat-icon>place</mat-icon>
              </a>

              <button
                mat-icon-button
                color="warn"
                type="button"
                (click)="delete(tour)"
                aria-label="Delete tour"
                matTooltip="Delete tour"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </li>
          </ul>
        </mat-card-content>
      </mat-card>

      <mat-card class="vh-admin-form">
        <mat-card-header>
          <mat-card-title>{{ isEditingExisting() ? 'Edit tour' : 'Create tour' }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <form [formGroup]="form" (ngSubmit)="save()">
            <div class="vh-admin-form-grid">
              <mat-form-field appearance="outline">
                <mat-label>Tour ID</mat-label>
                <input matInput formControlName="id" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Title</mat-label>
                <input matInput formControlName="title" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Location</mat-label>
                <input matInput formControlName="location" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Distance (km)</mat-label>
                <input matInput type="number" formControlName="distance_km" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Duration (minutes)</mat-label>
                <input matInput type="number" formControlName="duration_minutes" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Price (pence)</mat-label>
                <input matInput type="number" formControlName="price_cents" />
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Currency</mat-label>
                <input matInput formControlName="currency" />
              </mat-form-field>

              <mat-form-field appearance="outline" class="vh-admin-form-full">
                <mat-label>Route URL</mat-label>
                <input matInput formControlName="route_url" />
              </mat-form-field>

              <div class="vh-admin-form-full">
                <label class="vh-admin-upload-label">
                  Cover image
                  <input type="file" accept="image/*" (change)="onCoverSelected($event)" />
                </label>
                <div *ngIf="form.value.cover_image_url" class="vh-admin-cover-preview">
                  <img [src]="form.value.cover_image_url" alt="Tour cover preview" />
                </div>
              </div>

              <div class="vh-admin-form-full">
                <label class="vh-admin-upload-label">
                  Route GeoJSON file
                  <input
                    type="file"
                    accept=".geojson,application/geo+json,application/json"
                    (change)="onRouteSelected($event)"
                  />
                </label>
              </div>

              <div class="vh-admin-form-full vh-admin-toggle-row">
                <mat-slide-toggle formControlName="is_published"> Published </mat-slide-toggle>
              </div>
            </div>

            <button
              mat-raised-button
              color="primary"
              type="submit"
              class="vh-admin-save"
              [disabled]="saving()"
              [ngClass]="{ 'vh-admin-button--mobile': isMobile() }"
              matTooltip="Save tour"
            >
              <mat-icon>save</mat-icon>
              <span>Save</span>
            </button>

            <div class="vh-admin-json-row">
              <button
                mat-stroked-button
                type="button"
                (click)="exportJson()"
                [disabled]="!selectedId()"
                [ngClass]="{ 'vh-admin-button--mobile': isMobile() }"
                matTooltip="Export tour JSON"
              >
                <mat-icon>download</mat-icon>
                <span>Export JSON</span>
              </button>

              <label class="vh-admin-upload-label" matTooltip="Import tour JSON">
                Import JSON
                <input type="file" accept="application/json" (change)="onImportJson($event)" />
              </label>
            </div>
          </form>

          <p *ngIf="errorMessage()" class="vh-admin-error">
            {{ errorMessage() }}
          </p>
        </mat-card-content>
      </mat-card>
    </section>
  </main>
</div>
